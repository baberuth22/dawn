{% schema %}
{
  "name": "➕ SA - Conversation Form",
  "settings": [
    {
      "type": "text",
      "id": "form_id",
      "label": "Form ID",
      "default": "default-form-id",
      "info": "Provide the form ID. This will be used in the data attribute selector."
    }
  ],
  "presets": [
    {
      "name": "➕ SA - Conversation Form",
      "category": "Form"
    }
  ]
}
{% endschema %}

<div class="sa-conversational-form" id="cf-context-{{ section.id }}"></div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/space10-community/conversational-form@1.0.1/dist/conversational-form.min.js" crossorigin></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var formEmbedSelector = '[data-forms-id="forms-root-{{ section.settings.form_id }}"] form-embed';
    var contextId = "cf-context-{{ section.id }}";

    function initializeConversationalForm() {
      var shadowHostElement = document.querySelector(formEmbedSelector);

      if (shadowHostElement && shadowHostElement.shadowRoot) {
        var formElement = shadowHostElement.shadowRoot.querySelector("form");

        if (formElement) {
          // Hide the original form
          formElement.style.display = "none";

          // Initialize the conversational form
          window.cf.ConversationalForm.startTheConversation({
            formEl: formElement,
            context: document.getElementById(contextId),
            submitCallback: function() {
              formElement.submit(); // Submit the actual form
              conversationalForm.addRobotChatResponse(
                "Congratulations, you have reached the end of the form!"
              );
            }
          });
        } else {
          console.error("Form element not found within the Shadow DOM.");
        }
      } else {
        console.error("Shadow host element not found or does not contain a shadow root:", formEmbedSelector);
      }
    }

    // Wait for the shadow DOM to be available
    var observer = new MutationObserver(function(mutations, obs) {
      var shadowHostElement = document.querySelector(formEmbedSelector);
      if (shadowHostElement && shadowHostElement.shadowRoot) {
        initializeConversationalForm();
        obs.disconnect(); // Stop observing once we find the shadow DOM
      }
    });

    observer.observe(document, {
      childList: true,
      subtree: true
    });
  });
</script>
